# Implementation Plan: Add Prospect by Address

**Branch**: `011-add-prospect-by-address` | **Date**: 2026-01-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-add-prospect-by-address/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

This feature enables Regional Event Ambassadors (REAs) to add new prospective events by entering an address. The system automatically geocodes the address, infers the country from coordinates, and uses existing allocation algorithms to suggest appropriate Event Ambassadors (EAs). REAs can select from suggestions or manually choose an EA, and the prospect is immediately created, persisted, and displayed in the Prospects table and map view.

**Technical Approach**: Extend existing dialog patterns (`showAddressDialog`, `showEventAllocationDialog`) to create a new `showAddProspectDialog` function. Leverage existing geocoding utilities (`geocodeAddress`), country inference (`inferCountryCodeFromCoordinates`), and allocation algorithms (`suggestEventAllocation`). Integrate with existing prospect persistence and display mechanisms.

## Technical Context

**Language/Version**: TypeScript 5.9.3 (strict mode enabled)  
**Primary Dependencies**: 
- Leaflet (map rendering)
- Nominatim (geocoding service via existing `geocodeAddress` utility)
- Existing allocation algorithms (`suggestEventAllocation` from `actions/suggestEventAllocation`)
- Existing prospect persistence (`persistProspectiveEvents`, `loadProspectiveEvents`)
**Storage**: Browser localStorage (via existing prospect persistence mechanisms)  
**Testing**: Jest with jsdom environment  
**Target Platform**: Modern web browsers (ES6+)  
**Project Type**: Single-page web application  
**Performance Goals**: 
- Geocoding completes within 3 seconds (SC-003)
- Allocation suggestions displayed within 3 seconds of geocoding (SC-003)
- Prospect appears in table/map within 1 second of creation (SC-005)
- Complete prospect creation workflow under 2 minutes (SC-001)
**Constraints**: 
- Must work offline (geocoding requires network, but manual coordinate entry provides fallback)
- Must handle geocoding failures gracefully (FR-013, FR-014)
- Must maintain keyboard accessibility (Constitution V)
- Must use Australian English for all text (Constitution V)
**Scale/Scope**: 
- Single-user application (no concurrent editing concerns)
- Typical usage: 1-10 prospects added per session
- No rate limiting concerns for single-user geocoding requests

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **Quality Gates**: All code passes Prettier, ESLint, TypeScript type checking, and tests before commit
✅ **Test-Driven Development**: Tests written first for all production code, testing production code directly
✅ **Atomic Commits**: All changes committed with semantic commit messages following Conventional Commits
✅ **Single Responsibility**: Each component has single responsibility, code layout follows models/actions/parsers/types/utils structure
✅ **Accessibility**: All user inputs keyboard accessible, clean consistent accessible professional UI, Australian English
✅ **Open Source Preference**: Using existing open source libraries (Nominatim, Leaflet), no new dependencies required
✅ **Documentation**: README updated to document Add Prospect functionality
✅ **Production/Test Parity**: Code behaves identically in production and test, no environment-specific branches
✅ **Path Aliases**: All imports use path aliases (@actions/*, @models/*, etc.)

**Gate Status**: ✅ **PASS** - All constitution requirements satisfied. No violations detected.

## Project Structure

### Documentation (this feature)

```text
specs/011-add-prospect-by-address/
├── plan.md              # This file (/speckit.plan command output)
├── spec.md              # Feature specification
├── research.md          # Phase 0 output (/speckit.plan command) - COMPLETE
├── data-model.md        # Phase 1 output (/speckit.plan command) - COMPLETE
├── quickstart.md        # Phase 1 output (/speckit.plan command) - COMPLETE
├── contracts/           # Phase 1 output (/speckit.plan command) - COMPLETE
│   └── add-prospect-contracts.md
└── tasks.md             # Phase 2 output (/speckit.tasks command) - COMPLETE
```

### Source Code (repository root)

```text
src/
├── actions/
│   ├── showAddProspectDialog.ts        # NEW: Main dialog function
│   ├── showAddProspectDialog.test.ts   # NEW: Tests for dialog
│   ├── createProspectFromAddress.ts    # NEW: Core prospect creation logic
│   ├── createProspectFromAddress.test.ts # NEW: Tests for creation logic
│   ├── suggestEventAllocation.ts       # MODIFIED: Added generateProspectAllocationSuggestions
│   ├── suggestEventAllocation.test.ts   # NEW: Tests for prospect allocation
│   ├── persistProspectiveEvents.ts     # EXISTING: Used for persistence
│   └── populateProspectsTable.ts       # EXISTING: Used for table refresh
├── models/
│   ├── ProspectiveEvent.ts             # EXISTING: Data model
│   ├── CountryCode.ts                  # NEW: Country code type and utilities
│   ├── CountryCode.test.ts              # NEW: Tests for CountryCode
│   ├── country.ts                       # MODIFIED: Added inferCountryCodeFromCoordinates
│   ├── country.test.ts                  # MODIFIED: Added tests for country code inference
│   ├── EventTeamsTableData.ts           # MODIFIED: Updated to use CountryCode
│   └── EventTeamsTable.ts               # MODIFIED: Updated to use extractCountryCodeFromUrl
└── index.ts                            # MODIFIED: Add button handler

public/
└── index.html                           # MODIFIED: Add "Add Prospect" button
```

**Structure Decision**: Single-page web application structure. New functionality extends existing patterns:
- Dialog functions in `src/actions/` following `showAddressDialog`, `showEventAllocationDialog` patterns
- Core business logic in separate action files for testability
- Integration with existing prospect persistence and display mechanisms
- Button added to main toolbar in `public/index.html` alongside existing "Add" buttons

## Complexity Tracking

> **No violations detected - all constitution requirements satisfied**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |

---

## Phase 0: Outline & Research

✅ **Complete** - See [research.md](./research.md) for detailed findings.

**Key Decisions**:
1. Follow existing dialog patterns for consistency
2. Use existing geocoding utility with error handling
3. Create temporary EventDetails entry to reuse allocation algorithm
4. Follow existing prospect creation patterns (ID generation, validation)
5. Integrate with existing refresh and tracking mechanisms
6. Use existing country inference function
7. Implement automatic geocoding with debouncing
8. Implement automatic re-geocoding on address change

---

## Phase 1: Design & Contracts

✅ **Complete** - All design artifacts generated.

### Data Model

✅ **Complete** - See [data-model.md](./data-model.md)

**Key Entities**:
- `ProspectiveEvent` (existing, extended usage)
- Field population rules defined
- Validation rules documented
- State transitions documented

### API Contracts

✅ **Complete** - See [contracts/add-prospect-contracts.md](./contracts/add-prospect-contracts.md)

**Core Functions**:
- `showAddProspectDialog` - Main dialog function
- `createProspectFromAddress` - Core creation logic
- `generateProspectAllocationSuggestions` - EA suggestion generation
- `inferCountryCodeFromCoordinates` - Country inference helper

### Quickstart Guide

✅ **Complete** - See [quickstart.md](./quickstart.md)

**Includes**:
- User flow overview
- Basic implementation examples
- Key integration points
- Error handling patterns
- Testing guidance
- Common patterns

---

## Phase 2: Implementation Tasks

✅ **Complete** - See [tasks.md](./tasks.md) for all implementation tasks.

**Status**: All tasks (T001-T055) completed. Feature fully implemented and tested.
